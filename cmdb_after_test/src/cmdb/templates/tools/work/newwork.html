{% extends "public/joblayout.html" %}
{% block customstyle %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/jquery-ui.min.css') }}"/>
<link rel="stylesheet" href="/static/css/bootstrap-theme.css"/>
<link rel="stylesheet" href="/static/css/bootstrap-theme.min.css"/>
<link rel="stylesheet" href="/static/css/bootstrap.min.css"/>
<link rel="stylesheet" href="/static/css/bootstrap-treeview.min.css"/>
<link rel="stylesheet" href="/static/css/font-awesome.min.css"/>

{% endblock %}
{% block main %}
<h5 class="content_title">
    <span>新建作业</span>
</h5>
<hr>
<div class="panel-body" id="job_div">
    <div class="row">
        <div class="inline" style="margin-left: 25px;margin-bottom: 5px">
             <label class="label">作业名称</label><span><font color="red">&nbsp;*</font> </span>
             <input id="jobname" type="input"   placeholder="job name" style="width: 200px">
        </div>
        <ul id="step_ul" class="list-group">
            <li id="step_li" class="list-group-item step_li_c">
                <div class="inline row" style="background-color: #6DB96D;margin-left: 1px;height: 40px;">
                  <label class="label-important" style="margin-top: 5px"><font color="white">步骤名称</font> </label>
                   <span style="margin-top: 5px"><font color="red">&nbsp;*</font> </span>:&nbsp;&nbsp;&nbsp;&nbsp;</span>
                  <input id="step_name" style="width: 200px;margin-top: 5px" type="input"  placeholder="name">
                   <button id="delete_cr_step" style="background-color: white;margin-top: 7px;margin-right: 2px;color: red"  class="glyphicon glyphicon-remove pull-right btn-xs delete_cr_step"></button>
                   <button id="hide_detail"  style="background-color: white;margin-top: 7px;margin-right: 2px"  class="glyphicon glyphicon-chevron-down pull-right btn-xs hide_detail"></button>
                   <button id="show_detail" style="background-color: white;margin-top: 7px;margin-right: 2px"  class="glyphicon glyphicon-chevron-up pull-right btn-xs show_detail"></button>

               </div>
                <div class="row" style="margin-left: 2px;margin-top: 1px">
                    <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered mt20 dataTable no-footer" id="resultTable" role="grid" aria-describedby="resultTable_info">
                        <thead>
                        <tr role="row">
                            <th  class="text-center sorting_disabled" rowspan="1" colspan="1" style="width: 33%">脚本数量</th>
                            <th class="text-center sorting_disabled" rowspan="1" colspan="1" style="width: 33%">服务器数量</th>
                            <th class="text-center sorting_disabled" rowspan="1" colspan="1" style="width: 33%">操作</th>
                        </tr>
                    </thead>
                    </table>
                    <table  class="group-node-table table table-out-bordered table-condensed">
                        <tbody>
                            <tr>
                                <td style="width: 33%;text-align: center">
                                    <input id="script_count" type="text" value="0" class="form-control " style="margin-top:7px" disabled>
                                </td>
                                <td style="width: 33%;text-align: center">
                                    <input id="machine_count" type="text" value="0" class="form-control" style="margin-top:7px" disabled>
                                </td>
                                <td style="width: 33%;text-align: center">
                                    <a href="javascript:void(0)" title="编辑"  ><i style="margin-top: 11px;margin-left: 3px;margin-right: 3px;font-size: 20px" class="glyphicon glyphicon-pencil edit_node"></i></a>
                                    <a href="javascript:void(0)" title="上移"  ><i style="margin-top: 11px;margin-left: 3px;margin-right: 3px;font-size: 20px" class="glyphicon glyphicon-arrow-up up_node"></i></a>
                                    <a href="javascript:void(0)" title="下移"  ><i style="margin-top: 11px;margin-left: 3px;margin-right: 3px;font-size: 20px" class="glyphicon glyphicon-arrow-down down_node"></i></a>
{#                                    <a href="javascript:void(0)" title="删除"  ><i style="margin-top: 11px;margin-left: 3px;margin-right: 3px;font-size: 20px;color: red" class="glyphicon glyphicon-remove "></i></a>#}

                                </td>
                            </tr>
                            <tr id="table_detail" class="tag-tr">
                                <td colspan="5" class="tag_td">
                                    <div class="form-group pt10" style="margin-left: 15px">
                                        <label class="control-label inline ijobs-label-min">选择脚本类型<span class="red">&nbsp;*</span>£º</label>
                                        <div class="ijobs-input-min">
                                            <label class="radio-inline"> <input type="radio" value="1" name="scriptFrom" disabled="disabled"> shell
                                            </label> <label class="radio-inline"> <input type="radio" value="2" name="scriptFrom" > yaml
                                            </label> <label class="radio-inline"> <input type="radio" value="3" name="scriptFrom" disabled="disabled"> python
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin-top: 20px">
                                        <div class="row">
                                            <div class="col-sm-6 col-md-6 col-lg-6 " >
                                                 <div>
                                                    <button class="btn btn-success add_script" id="add_script" style="margin-left: 10px">
                                                        <i class="glyphicon glyphicon-list-alt" ></i>&nbsp;选择脚本
                                                    </button>
                                                     <div class="col-sm-12 col-md-12 col-lg-12 table-responsive" style="overflow-y:auto; overflow-x:auto;height: 300px;margin-top: 15px">
                                                        <table class="table table-out-bordered table-condensed" style="">
                                                            <thead>
                                                                <tr role="row">
                                                                    <th class="text-left sorting_disabled" rowspan="1" colspan="1" >名称</th>
                                                                    <th class="text-left sorting_disabled" rowspan="1" colspan="1" >文件路径</th>
                                                                    <th class="text-left sorting_disabled" rowspan="1" colspan="1" >文件名</th>
    {#                                                                <th class="text-left sorting_disabled" rowspan="1" colspan="1" >部门</th>#}
    {#                                                                <th class="text-left sorting_disabled" rowspan="1" colspan="1" >文件类型</th>#}
                                                                    <th class="text-center sorting_disabled" rowspan="1" colspan="1" >操作</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="script_list">

                                                            </tbody>
                                                        </table>
                                                     </div>

                                                </div>
                                            </div>

                                            <div class="col-sm-6 col-md-6 col-lg-6 " >

                                                 <div>
                                                    <button class="btn btn-success add_machine" id="add_machine" style="margin-left: 10px">
                                                        <i class="fi fi-monitor" ></i>&nbsp;选择机器
                                                    </button>
                                                      <button class="btn btn-danger delete_all_machine" id="add_all_machine" style="margin-left: 10px">
                                                        <i class="glyphicon glyphicon-remove" ></i>&nbsp;全部删除
                                                    </button>
                                                     <div class="row">
                                                         <div class="col-sm-12 col-md-12 col-lg-12 table-responsive" style="overflow-y:auto; overflow-x:auto;height: 300px;margin-top: 15px">
                                                             <table class="table table-out-bordered table-condensed" >
                                                                <thead>
                                                                    <tr role="row">
                                                                        <th class="text-left sorting_disabled" rowspan="1" colspan="1" >机器名</th>
                                                                        <th class="text-left sorting_disabled" rowspan="1" colspan="1" >IP</th>
                                                                        <th class="text-left sorting_disabled" rowspan="1" colspan="1" >部门</th>
                                                                        <th class="text-center sorting_disabled" rowspan="1" colspan="1" >Pool</th>
                                                                        <th class="text-center sorting_disabled" rowspan="1" colspan="1">操作</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody class="machine_list">

                                                                </tbody>
                                                             </table>
                                                         </div>
                                                         <div class="col-sm-6 col-md-6 col-lg-6 " >
{#                                                             <textarea style="width: 90%;margin-left: 13px;margin-top: 15px;height: 300px"></textarea>#}
                                                         </div>
                                                     </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
{#                <a href="javascript:void(0);" class="add-node"><i style="font-size: 20px" class="glyphicon-plus"></i>&nbsp;&nbsp;<font size="4">新增节点</font></a>#}
            </li>

        </ul>
        <div>
            <button class="btn btn-success" id="add_step" style="margin-left: 10px"><i class="glyphicon glyphicon-plus" ></i>&nbsp;添加新步骤 </button>
        </div>
    </div>
    <div class="text-center">
        <hr>
        <button class="btn btn-danger" type="button" id="act_script" style="background-color: red">
            <i class="fa fa-life-saver"></i> 执行脚本
        </button>
        <button class="btn btn-primary" type="button" id="save_script" style="background-color: #0077b3">
            <i class="fa fa-save"></i> 保存
        </button>
    </div>
</div>

<div>
    <pre id="progress"></pre>
</div>


<div class="modal fade form-horizontal" style="height: auto" id="mymodal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">x</span><span class="sr-only">Close</span></button>
				<h4 id="poptitle" class="modal-title">选择机器:&nbsp;&nbsp;<i id="loadmachine" class="fa fa-spinner fa-spin"></i></h4>

			</div>
            <ul id="myTab" class="nav nav-tabs">
               <li class="active">
                  <a href="javascript:void(0)" onclick="gotopage(1)" data-toggle="tab">
                     选择机器
                  </a>
               </li>

                 <li >
                  <a href="javascript:void(0)" onclick="gotopage(2)" data-toggle="tab">
                     输入机器
                  </a>
               </li>
            </ul>
			<div id="s_machine" class="modal-body">
                <input type="input" class="form-control" id="input-check-node" placeholder="Search..." >
                <div id="tree"></div>
			</div>
            <div id="i_machine" class="modal-body">
                <textarea style=""  name="code" class="brush: js;" id="input_machine" rows="20" placeholder="请输入机器ip，逗号分割"></textarea>
			</div>
			<div class="modal-footer">
                <div data-alert class="alert-box alert pull-left" id="msgtips" style="display: none;">
                    This is an alert - alert that is rounded.<a class="close" href="#">x</a>
{#                    <a href="javascript:void(0);" class="close">&times;</a>#}
                </div>
				<button type="button" class="btn btn-warning btn-lg" data-dismiss="modal">close</button>
				<button id="ok_machine" type="button" class="btn btn-primary btn-lg ok_machine">确定</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade form-horizontal" style="height: auto" id="mymodal_script">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">x</span><span class="sr-only">Close</span></button>
				<h4 id="poptitle_script" class="modal-title">选择脚本:&nbsp;&nbsp;<i id="loadscript" class="fa fa-spinner fa-spin"></i></h4>

			</div>
			<div  class="modal-body">
                <input type="input" class="form-control" id="input-check-script" placeholder="Search..." >
                <div id="treescript"></div>
			</div>

			<div class="modal-footer">
                <div data-alert class="alert-box alert pull-left" id="msgtips" style="display: none;">
                    This is an alert - alert that is rounded.<a class="close" href="#">x</a>
{#                    <a href="javascript:void(0);" class="close">&times;</a>#}
                </div>
				<button type="button" class="btn btn-warning btn-lg" data-dismiss="modal">close</button>
				<button id="ok_script" type="button" class="btn btn-primary btn-lg ok_script">确定</button>
			</div>
		</div>
	</div>
</div>

{% block customscript %}
{% assets filters="jsmin", output="asset/runscripts.js","js/jquery-ui.min.js","js/jobplat/runscripts.js" %}
<script type="text/javascript" src="{{ ASSET_URL }}"></script>
<script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/static/js/bootstrap-treeview.min.js"></script>
{% endassets %}
{% endblock %}
<script>



     $("#progress").hide()

     $("#step_li").hide()
     var step=$("#step_li").clone(true).attr('id','new_step_li')

     step.show()
     $("#step_ul").append(step)
     c_index=($('.step_li_c').index(step))

     step.find($("input[name='scriptFrom']")).each(function(index){
        $(this).attr('name','scriptFrom'+c_index*2)
     })

    $("#add_step").click(function () {
         var step=$("#step_li").clone(true).attr('id','new_step_li')

         step.show()
         $("#step_ul").append(step)
         c_index=($('.step_li_c').index(step))
         step.find($("input[name='scriptFrom']")).each(function(index){
             $(this).attr('name','scriptFrom'+c_index*2)
         })

    })

     $("#step_ul").on("click",".show_detail",function(){
          $(this).parents('.step_li_c').find("#table_detail").each(function () {
             $(this).hide()
         })
     })

     $("#step_ul").on("click",".hide_detail",function(){
          $(this).parents('.step_li_c').find("#table_detail").each(function () {
             $(this).show()
         })
     })

     $("#step_ul").on("click",".delete_cr_step",function(){
          $(this).parents('.step_li_c').each(function () {
             $(this).remove()
         })
     })

     $("#step_ul").on("click",".edit_node",function(){
          $(this).parents('.step_li_c').find("#table_detail").each(function () {
             $(this).show()
         })
     })


     $("#step_ul").on("click",".down_node",function(){
         $(this).parents('#new_step_li').each(function(){
             c_index=($('.step_li_c').index(this))
             all_index=($("#step_ul").children('.step_li_c').length)
             if(c_index<all_index){
                 togglePostion($(this),$($("#step_ul").children('.step_li_c')[c_index+1]))
             }
         })
     })

     $("#step_ul").on("click",".up_node",function(){
         $(this).parents('#new_step_li').each(function(){
             c_index=($('.step_li_c').index(this))
             all_index=($("#step_ul").children('.step_li_c').length)
             if(c_index>1){
                 togglePostion($($("#step_ul").children('.step_li_c')[c_index-1]),$(this))
             }
         })
     })

     var defaultData=''
     var scriptData2=''

     loadhost()

     var current_index=0
     $("#step_ul").on("click",".add_machine",function(){
         $(this).parents('#new_step_li').each(function() {
              c_index = ($('.step_li_c').index(this))
              current_index=c_index
          })
          $("#mymodal").modal('show')
          $("#loadmachine").show()
          if(defaultData){
              setTree()
              $("#loadmachine").hide()
          }
          else {
              loadhost()
          }

     })

      $("#step_ul").on("click",".delete_all_machine",function(){
           $(this).parents('.step_li_c').find(".machine_list").each(function () {
             $(this).empty()
         })
      })

     $("#step_ul").on("click",".add_script",function(){
          $(this).parents('#new_step_li').each(function() {
              c_index = ($('.step_li_c').index(this))
              current_index=c_index
          })
          $("#mymodal_script").modal('show')
          $("#loadscript").show()
          if(scriptData2){
              setTree_script()
              $("#loadscript").hide()
          }
          else {
              loadscript()
          }

     })

      $("#mymodal_script").on("click",".ok_script",function(){
            s_count=0
            $.each($('#treescript').treeview('getChecked'), function(i, item){
                if (item){
                    if (item.level==2){
                        $($('.step_li_c')[current_index]).find('.script_list').each(function () {
                            s_count+=1
                             $(this).append('<tr id="tr_script" role="row" '+' class="odd tr_script"><td>'+item.text+'</td>' +
                                     '<td>'+item.path+'</td><td>'+item.filename+'</td>' +
                                     '<td >' +
                                     '<div class="btn-list btn-xs span7 text-center" >' +
                                     '<button class="glyphicon glyphicon-arrow-up btn-xs script_up">' +
                                     '</button><button style="margin-left: 2px;margin-right: 2px" class="glyphicon glyphicon-arrow-down btn-xs script_down"></button>' +
                                     '<span class="mr5" style="border-left:2px solid #bbb;padding:2px 0 2px 2px; "' +
                                     '></span><button class="btn btn-danger btn-xs del_script">删除</button><input class="script_id" value='+item.id+' id='+item.id+' type="hidden"/></div></td ></tr>')

                         })
                    }
                }
             })
            $($('.step_li_c')[current_index]).find('#script_count').val(parseInt( $($('.step_li_c')[current_index]).find('#script_count').val())+s_count)
            $("#mymodal_script").modal('hide')
     })

     $("#step_ul").on("click",".del_script",function(){
         $(this).parents('tr')[0].remove()
         $($('.step_li_c')[current_index]).find('#script_count').val(parseInt( $($('.step_li_c')[current_index]).find('#script_count').val())-1)
{#          del_index= parseInt($(this).next('input').attr('id'))#}
{#          $(this).parents('.step_li_c').find(".script_list").each(function () {#}
{#                #}
{#         })#}
     })

      $("#step_ul").on("click",".script_up",function(){

           if ($($(this).parents('#tr_script')[0]).prev('.tr_script')) {
               togglePostion($($(this).parents('.tr_script')[0]).prev('.tr_script'), $($(this).parents('.tr_script')[0]))
           }

      })
      $("#step_ul").on("click",".script_down",function(){

           if ($($(this).parents('#tr_script')[0]).next('.tr_script')) {
               togglePostion( $($(this).parents('.tr_script')[0]),$($(this).parents('#tr_script')[0]).next('.tr_script'))
           }

      })


        add_machine_model=1
        set_add_machine(1)

        function set_add_machine(my_model){
            if(my_model==1){
                $("#s_machine").show()
                $("#i_machine").hide()
            }
            else{
                $("#s_machine").hide()
                $("#i_machine").show()
            }
        }

        function gotopage(my_model){
        add_machine_model=my_model
        set_add_machine(my_model)
    }

      $("#mymodal").on("click",".ok_machine",function(){
            s_count=0
           if(add_machine_model==1){
               $.each($('#tree').treeview('getChecked'), function(i, item){
                if (item){
                    if (item.level==3){
                        $($('.step_li_c')[current_index]).find('.machine_list').each(function () {
                            s_count+=1
                             $(this).append('<tr id="tr_machine" role="row" '+' class="odd tr_script"><td>'+item.name+'</td>' +
                                     '<td >'+item.ip+'</td><td>'+item.depname+'</td><td>'+item.poolname+'</td>' +
                                     '<td >' +
                                     '<div class="btn-list btn-xs span7 text-center" >' +
                                     '<button class="btn btn-danger btn-xs del_machine">删除</button><input class="machine_id" ip='+item.ip+' value='+item.id+' id='+item.id+' type="hidden"/></div></td ></tr>')

                         })
                    }
                }
             })
           }
           else{
               add_items=[]
               level3=[]
               ips=$("#input_machine").val().split(',')
               if(ips.length==1){
                    ips=$("#input_machine").val().split('\n')
               }
                $.each(defaultData,function(i,item){
                     $.each(item.nodes,function(j,item1){
                         $.each(item1.nodes,function(k,item2){
                              $.each(ips,function(v,ip){
                                  if(ip==item2.ip){
                                      s_count+=1
                                      level3.push(item2)
                                  }
                              })
                         })
                     })
                })
                 $.each(level3,function(i,item){
                     $($('.step_li_c')[current_index]).find('.machine_list').each(function () {
                            s_count+=1
                             $(this).append('<tr id="tr_machine" role="row" '+' class="odd tr_script"><td>'+item.name+'</td>' +
                                     '<td >'+item.ip+'</td><td>'+item.depname+'</td><td>'+item.poolname+'</td>' +
                                     '<td >' +
                                     '<div class="btn-list btn-xs span7 text-center" >' +
                                     '<button class="btn btn-danger btn-xs del_machine">删除</button><input class="machine_id" ip='+item.ip+' value='+item.id+' id='+item.id+' type="hidden"/></div></td ></tr>')

                         })
                 })
           }


            $($('.step_li_c')[current_index]).find('#machine_count').val(parseInt( $($('.step_li_c')[current_index]).find('#machine_count').val())+s_count)
            $("#mymodal").modal('hide')
      })

      $("#step_ul").on("click",".del_machine",function(){
         $(this).parents('tr')[0].remove()
         $($('.step_li_c')[current_index]).find('#machine_count').val(parseInt( $($('.step_li_c')[current_index]).find('#machine_count').val())-1)
{#          del_index= parseInt($(this).next('input').attr('id'))#}
{#          $(this).parents('.step_li_c').find(".script_list").each(function () {#}
{#                #}
{#         })#}
     })

     function loadhost(){
         $.ajax({
                  'url': '/cmdb/work/gethost',
                  'type': 'post',
                  'dataType': 'json',
                  'data': {},
                  success: function (res) {
                      if (!defaultData) {
                          defaultData = res
                          setTree()
                          $("#loadmachine").hide()
                      }
                  },
                  error: function (res) {
                      console.log(res)
                  }
      })
     }

     function loadscript(){
         $.ajax({
                  'url': '/cmdb/work/getscript',
                  'type': 'post',
                  'dataType': 'json',
                  'data': {},
                  success: function (res) {
                      scriptData2 = res
                      setTree_script()
                      $("#loadscript").hide()

                  },
                  error: function (res) {
                      console.log(res)
                  }
         })
     }

     var findCheckableNodess = function(type) {
         if (type==1) {
             return $checkableTree.treeview('search', [$('#input-check-node').val(), {
                 ignoreCase: true,
                 exactMatch: false,
                 revealResults: true,
             }]);
         }
         else{
            return $scriptTree.treeview('search', [$('#input-check-script').val(), {
                 ignoreCase: true,
                 exactMatch: false,
                 revealResults: true,
             }]);
         }
    };
     var checkableNodes = ''
        // Check/uncheck/toggle nodes
     $('#input-check-node').on('keyup', function (e) {
          checkableNodes = findCheckableNodess(1);
          $('.check-node').prop('disabled', !(checkableNodes.length >= 1));
    });
     $('#input-check-script').on('keyup', function (e) {

          checkableNodes = findCheckableNodess(0);
          $('.check-node').prop('disabled', !(checkableNodes.length >= 1));
    });

     var $checkableTree=''
     var $scriptTree=''
     function setTree(){
         $checkableTree = $('#tree').treeview({
              data: defaultData,
              showIcon: false,
              showCheckbox: true,
              showTags:true,

              onNodeChecked: function(event, node) {
{#                $('#checkable-output').prepend('<p>' + node.text + ' was checked</p>');#}
{#                    node.nodes[0].state.checked=true#}
                    var children = node.nodes;

{#                    if (node.state.expanded==false) {#}
{#                        $('#tree').treeview('expandNode', node['nodeId']);#}
{#                    }#}
                    if (children) {
                        for (var i = 0; i < children.length; i++) {
                            var childNode = children[i];
                            var nodeId = childNode['nodeId'];
                            $('#tree').treeview('checkNode', nodeId);
{#                            $('#tree').treeview('expandNode', nodeId);#}
                        }
                    }
                },
              onNodeUnchecked: function (event, node) {
{#                $('#checkable-output').prepend('<p>' + node.text + ' was unchecked</p>');#}
                  var children = node.nodes;
                    if (children) {
                        for (var i = 0; i < children.length; i++) {
                            var childNode = children[i];
                            var nodeId = childNode['nodeId'];
                            $('#tree').treeview('uncheckNode', nodeId);
                        }
                    }
              }
          });
         $('#tree').treeview('collapseAll', { silent: true });
     }

     function setTree_script(){
         $scriptTree = $('#treescript').treeview({
              data: scriptData2,
              showIcon: false,
              showCheckbox: true,
              showTags:true,

              onNodeChecked: function(event, node) {
{#                $('#checkable-output').prepend('<p>' + node.text + ' was checked</p>');#}
{#                    node.nodes[0].state.checked=true#}
                    var children = node.nodes;

{#                    if (node.state.expanded==false) {#}
{#                        $('#tree').treeview('expandNode', node['nodeId']);#}
{#                    }#}
                    if (children) {
                        for (var i = 0; i < children.length; i++) {
                            var childNode = children[i];
                            var nodeId = childNode['nodeId'];
                            $('#treescript').treeview('checkNode', nodeId);
{#                            $('#tree').treeview('expandNode', nodeId);#}
                        }
                    }
                },
              onNodeUnchecked: function (event, node) {
{#                $('#checkable-output').prepend('<p>' + node.text + ' was unchecked</p>');#}
                  var children = node.nodes;
                    if (children) {
                        for (var i = 0; i < children.length; i++) {
                            var childNode = children[i];
                            var nodeId = childNode['nodeId'];
                            $('#treescript').treeview('uncheckNode', nodeId);
                        }
                    }
              }
          });
         $('#treescript').treeview('collapseAll', { silent: true });
     }

     function togglePostion(a,b){
        var a1 = $("<div id='a1'></div>").insertBefore(a);
        var b1 = $("<div id='b1'></div>").insertBefore(b);

        a.insertAfter(b1);
        b.insertAfter(a1);
        a1.remove();
        b1.remove();
        a1 = b1 = null;

    }

     var txt = '';
     $("#act_script").click(function(){
         job_name=$('#jobname').val()
         if(!job_name){
             alert('请输入作业名称!')
             return false
         }
         s_count=0
         job_info=[]
         $(".step_li_c").each(function () {
             s_count+=1
             if(s_count>1){
                 step_name=$(this).find('#step_name').val()
                 if(!step_name){
                     alert('请输入步骤名称!')
                     return false
                 }
                 script_count=$(this).find('#script_count').val()
                 if (parseInt(script_count)<1 ||!script_count){
                     alert('请选择执行脚本!')
                     return false
                 }
                 scripts=[]
                 $(this).find('.script_id').each(function () {
                     scripts.push($(this).val())
                 })
                 machine_count=$(this).find('#machine_count').val()
                 if (parseInt(machine_count)<1 ||!machine_count){
                     alert('请选择执行机器!')
                     return false
                 }
                 machines=[]
                 $(this).find('.machine_id').each(function () {
                     machines.push({id:$(this).val(),ip:$(this).attr('ip')})
                 })
                 job_info.push({step_name:step_name,scripts:scripts,machines:machines})

             }

         })
         if(job_info){
            $("#progress").show()
{#            $("#job_div").hide()#}
             txt=''
            $.ajax({
                type: 'POST',
                url: '/cmdb/work/startwork',
                'dataType': 'json',
                'data': {job_info:JSON.stringify(job_info),job_name:job_name},
            success: function (data, status, request) {
                status_url = request.getResponseHeader('Location');
                {#                    alert(status_url)#}
                update_progress_info(status_url);
            },
            error: function () {
                alert('Unexpected error');
            }
            });
         }

     })

     $("#save_script").click(function(){
         job_name=$('#jobname').val()
         if(!job_name){
             alert('请输入作业名称!')
             return false
         }
         s_count=0
         job_info=[]
         $(".step_li_c").each(function () {
             s_count+=1
             if(s_count>1){
                 step_name=$(this).find('#step_name').val()
                 if(!step_name){
                     alert('请输入步骤名称!')
                     return false
                 }
                 script_count=$(this).find('#script_count').val()
                 if (parseInt(script_count)<1 ||!script_count){
                     alert('请选择执行脚本!')
                     return false
                 }
                 scripts=[]
                 $(this).find('.script_id').each(function () {
                     scripts.push($(this).val())
                 })
                 machine_count=$(this).find('#machine_count').val()
                 if (parseInt(machine_count)<1 ||!machine_count){
                     alert('请选择执行机器!')
                     return false
                 }
                 machines=[]
                 $(this).find('.machine_id').each(function () {
                     machines.push({id:$(this).val(),ip:$(this).attr('ip')})
                 })
                 job_info.push({step_name:step_name,scripts:scripts,machines:machines})

             }

         })
         if(job_info){
{#            $("#progress").show()#}
{#            $("#job_div").hide()#}
             txt=''
            $.ajax({
                type: 'POST',
                url: '/cmdb/work/savework',
                'dataType': 'json',
                'data': {job_info:JSON.stringify(job_info),job_name:job_name},
            success: function (data) {
                if(data.state==1){
                    alert('success!')
                }
                else if(data.state==2){
                    alert('作业名已存在!')
                }
                else{
                    alert('failed!')
                }
            },
            error: function () {
                alert('Unexpected error');
            }
            });
         }

     })

    function update_progress_info(status_url) {
            // send GET request to status URL
            $.getJSON(status_url, function(data) {

                try{
                    $('#progress').text('');
                    if(data.status.msg){
                        txt=''
                         $.each(data.status.msg, function(p1, p2){
                            txt += format_log(p2);
                        });
                        $('#progress').text(txt);

                        label_red()
                    }


                }

                catch(e){

                }

{#                if (data['state'] == 'PENDING' || data['state'] == 'PROGRESS') {#}
                  if (data['state'] !='MYFINSHIED') {
                    // rerun in 2 seconds
                    setTimeout(function() {
                        update_progress_info(status_url);
                    }, 1000);
                }
            });
        }

    function label_red(){

        $("#progress").each(function(i,n){
            t=$(this).text()
            error_c=['1','2','3','4','5','6','7','8','9']
            $.each(error_c, function(p1, p2) {
                var regExp = new RegExp("'unreachable': "+p2, "g")
                t = t.replace(regExp, ("<font color='red'>'unreachable: '"+p2+"</font>"));
                var regExp = new RegExp("'failures': "+p2, "g")
                t = t.replace(regExp, ("<font color='red'>'failures: '"+p2+"</font>"));

            })
            $('#progress').html(t);
        })
    }

    function format_log(_info){
        if(_info.indexOf('unreachable')>-1){
            sp1=_info.split("failures'")
            sp2=''
            if(sp1.length>1){
                $.each(sp1, function(_ind, p2){
                    if(_ind<sp1.length-1){
                        s_add=p2+"failures'"+sp1[_ind+1].split(',')[0]
                        sp1[_ind+1]=sp1[_ind+1].replace(sp1[_ind+1].split(',')[0],'')
                        sp2+=s_add+'\n'
                    }
                    else{
                        s_add=p2+sp1[_ind+1]
                        sp2+=s_add+'\n'
                    }
                })
            }
            return sp2
        }
        else{
            return _info+'\n'
        }
    }

</script>
{% endblock %}
